#!/bin/sh
# postinst script for solv

set -e

case "$1" in
    configure)
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# Create solv user if it doesn't exist
if ! id -u solv > /dev/null 2>&1; then
    useradd -m solv
fi

# Install zsh
apt-get install -y zsh

# Change the default shell for solv user to zsh
chsh -s $(which zsh) solv

# Install oh-my-zsh for solv user
sudo -u solv -H sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"

# Check if nodenv is already installed for solv user
sudo -u solv -H sh -c 'if [ ! -d "/home/solv/.nodenv" ]; then
    git clone https://github.com/nodenv/nodenv.git ~/.nodenv
    ln -vs /home/solv/.nodenv/bin/nodenv /usr/local/bin/nodenv
    cd /home/solv/.nodenv && src/configure && make -C src || true
    mkdir -p "$(nodenv root)"/plugins
    git clone https://github.com/nodenv/node-build.git "$(nodenv root)"/plugins/node-build
    git clone https://github.com/nodenv/nodenv-aliases.git $(nodenv root)/plugins/nodenv-aliases
    nodenv install 18.17.1
    nodenv global 18.17.1
    if ! grep -q "nodenv init" ~/.zshrc; then
        echo "$(nodenv init - zsh)" >> ~/.zshrc
    fi
fi
'

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
